**EXPERIMENTAL: This chart guarantees no compatability with future versions and is subject to change**

# Prefect Server Helm Chart

## Usage

1. Clone repository

2. Change to this directory

3. Download the postgresql dependency if you are not using an existing database

```
$ helm dependency update
```

4. Install the chart with your desired name e.g. "my-prefect-server"

```
$ helm install <name-to-label-release> . [helm options]
```

## Options:

See comments in `values.yaml`.

### Database

The database can be deployed by this chart or be provided externally. 
We strongly recommend that you do not deploy a production database using this chart, the provided database is primarily for testing purposes.
The provided database will **not** persist your data by default.

An external database will require some minimal setup for Hasura.
The following needs to be run or the user should have permissions to execute it and Hasura will run it on startup:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
SET TIME ZONE 'UTC';
```

## Troubleshooting

### The UI loads but the dashboard is blank

If you go to the 'Home' page it will likely direct you to create a tenant. Without a tenant, the dashboard cannot display.
Run `prefect backend server && prefect server create-tenant --name default --slug default` to create a default tenant.

### The UI loads but cannot connect to the API

Check that the API url is correct under the `server_url` key at the UI url `/settings.json` e.g. `http://localhost:8080/settings.json`.
This should match the url that the Apollo service is deployed to e.g. `http://localhost:4200/graphql`
This endpoint must be accessible by *the user* of the UI, not just the server, since requests come from the user's browser.

### The database deploys correctly but other services fail with "bad password"

If you are using the subchart deployed database with persistence enabled, 
it is likely the password for the user has persisted between deployments in the PVC for the database but the secret has been regenerated by the Helm chart and does not match. 
Deploy and set the 'postgresql.existingSecret' option or set a constant password at `postgresql.postgresqlPassword`.
